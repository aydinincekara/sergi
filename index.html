<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Efsaneler Sergisi AR v1.3.0</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
      body { margin: 0; font-family: 'Segoe UI', sans-serif; overflow: hidden; background: black; }

      /* --- SAÄž ÃœST PANEL (SADELEÅžTÄ°RÄ°LMÄ°Åž) --- */
      #top-right-panel {
        position: fixed; top: 15px; right: 15px; z-index: 1000;
        display: flex; align-items: center; gap: 8px;
      }
      .version-tag {
        background: rgba(0, 0, 0, 0.6); color: #00ff00; padding: 4px 8px;
        border: 1px solid #00ff00; border-radius: 4px; font-weight: bold; font-size: 12px;
      }
      #log-btn {
        background: rgba(0, 0, 0, 0.6); color: white; border: 1px solid #555; 
        border-radius: 50%; width: 32px; height: 32px; cursor: pointer; 
        display: flex; align-items: center; justify-content: center; font-size: 16px;
        transition: background 0.2s;
      }
      #log-btn:hover { background: rgba(255, 255, 255, 0.2); }

      /* --- LOG PENCERESÄ° --- */
      #log-modal {
        position: fixed; top: 60px; right: 15px; width: 280px; max-height: 200px;
        background: rgba(0, 0, 0, 0.9); z-index: 999;
        overflow-y: auto; border: 1px solid #444; display: none;
        color: #0f0; font-family: monospace; font-size: 10px; padding: 10px; border-radius: 5px;
      }
      .log-entry { border-bottom: 1px solid #333; padding: 3px 0; }
      .log-time { color: #888; margin-right: 5px; }

      /* --- YÃœKLEME BAR --- */
      #loader-overlay {
        position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%);
        width: 60%; z-index: 2000; display: none;
        text-align: center; background: rgba(0, 0, 0, 0.8); padding: 10px 20px; 
        border-radius: 20px; border: 1px solid #444;
      }
      .progress-container {
        width: 100%; background-color: #333; border-radius: 5px; margin-top: 5px; height: 6px; overflow: hidden;
      }
      .progress-bar {
        width: 0%; height: 100%; background-color: #00ff00; transition: width 0.2s;
      }
      .loading-text { color: white; font-size: 12px; }

      /* --- BAÅžLANGIÃ‡ EKRANI --- */
      #start-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.95); z-index: 3000;
        display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;
      }
      #start-btn {
        padding: 15px 50px; font-size: 18px; background: #27ae60; color: white;
        border: none; border-radius: 50px; cursor: pointer; margin-top: 20px;
        font-weight: bold; letter-spacing: 1px;
      }
    </style>
  </head>
  <body>

    <div id="start-screen">
      <h1>SANAL SERGÄ°</h1>
      <p style="color: #aaa; font-size: 14px;">LÃ¼tfen kameraya izin verin</p>
      <button id="start-btn">BAÅžLAT</button>
    </div>

    <div id="top-right-panel">
      <div class="version-tag">v1.3.0</div>
      <button id="log-btn" title="LoglarÄ± GÃ¶ster">ðŸ“‹</button>
    </div>

    <div id="log-modal">
      <div id="log-content"></div>
    </div>

    <div id="loader-overlay">
      <div class="loading-text"><span id="load-name">Medya</span> YÃ¼kleniyor... %<span id="load-percent">0</span></div>
      <div class="progress-container">
        <div class="progress-bar" id="load-bar"></div>
      </div>
    </div>

    <a-scene 
      mindar-image="imageTargetSrc: ./konser/targets.mind; maxTrack: 1; filterMinCF:0.0001; filterBeta: 0.001; warmupTolerance: 5; missTolerance: 5" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">

      <a-assets>
        <audio id="soundOrhan" preload="none"></audio>
        <video id="vidVeysel" preload="none" loop="true" playsinline webkit-playsinline crossorigin="anonymous"></video>
        <video id="vidBaris" preload="none" loop="true" playsinline webkit-playsinline crossorigin="anonymous"></video>
        <video id="vidZeki" preload="none" loop="true" playsinline webkit-playsinline crossorigin="anonymous"></video>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0" class="art-target" 
                data-id="#soundOrhan" data-src="./konser/Hatasiz_Kul_Olmaz-Orhan _Gencebay.mp3" data-name="Orhan Gencebay">
        <a-entity position="0 0 0" animation="property: rotation; to: 0 0 360; dur: 5000; easing: linear; loop: true">
            <a-ring color="black" radius-inner="0.1" radius-outer="0.5"></a-ring>
            <a-circle color="#c0392b" radius="0.15"></a-circle>
        </a-entity>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 1" class="art-target" 
                data-id="#vidVeysel" data-src="./konser/asik_veysel_trt_kara_toprak.mp4" data-name="AÅŸÄ±k Veysel">
        <a-video src="#vidVeysel" position="0 0 0" height="1" width="1"></a-video>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 2" class="art-target" 
                data-id="#vidBaris" data-src="./konser/baris_manco_Gulpembe.mp4" data-name="BarÄ±ÅŸ ManÃ§o">
        <a-video src="#vidBaris" position="0 0 0" height="1" width="1.3"></a-video>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 3" class="art-target" 
                data-id="#vidZeki" data-src="./konser/zeki_muren_Ah_bu_sarkilarin_gozu_kor_olsun.mp4" data-name="Zeki MÃ¼ren">
        <a-video src="#vidZeki" position="0 0 0" height="1" width="1"></a-video>
      </a-entity>

    </a-scene>

    <script>
      // --- VERSÄ°YON GEÃ‡MÄ°ÅžÄ° ---
      const VERSION_HISTORY = [
        "v1.3.0: UI SadeleÅŸtirildi (Ä°kon). GeÃ§iÅŸ hatasÄ± (Video Stuck) dÃ¼zeltildi.",
        "v1.2.0: BaÅŸlat butonu kilidi eklendi.",
        "v1.0.0: Ä°lk sÃ¼rÃ¼m."
      ];

      let isAppStarted = false;
      const startScreen = document.getElementById('start-screen');
      const startBtn = document.getElementById('start-btn');
      
      // Loglar
      const logContent = document.getElementById('log-content');
      const logModal = document.getElementById('log-modal');
      const logBtn = document.getElementById('log-btn');

      // Loader
      const loaderOverlay = document.getElementById('loader-overlay');
      const loadBar = document.getElementById('load-bar');
      const loadPercent = document.getElementById('load-percent');
      const loadName = document.getElementById('load-name');

      function addLog(msg) {
        const now = new Date();
        const time = now.toLocaleTimeString().split(' ')[0]; // Sadece saati al
        const div = document.createElement('div');
        div.className = 'log-entry';
        div.innerHTML = `<span class="log-time">${time}</span> ${msg}`;
        logContent.prepend(div);
        console.log(`[AR] ${msg}`);
      }

      VERSION_HISTORY.forEach(h => addLog(h));

      logBtn.addEventListener('click', () => {
        logModal.style.display = (logModal.style.display === 'block') ? 'none' : 'block';
      });

      startBtn.addEventListener('click', () => {
        isAppStarted = true;
        startScreen.style.display = 'none';
        addLog("Sistem BaÅŸlatÄ±ldÄ±.");
        // Ses kilidini aÃ§
        const dummy = new Audio();
        dummy.play().then(()=>dummy.pause()).catch(()=>{});
      });

      // --- KRÄ°TÄ°K DÃœZELTME: SIKI GEÃ‡Ä°Åž KONTROLÃœ ---
      
      function stopOtherMedias(exceptId) {
        const allMedia = document.querySelectorAll('video, audio');
        allMedia.forEach(media => {
          if (media.id !== exceptId.replace('#', '')) {
            media.pause();
            media.currentTime = 0; // BaÅŸa sar ki arkada kalmasÄ±n
          }
        });
      }

      const targets = document.querySelectorAll('.art-target');

      targets.forEach(target => {
        target.addEventListener("targetFound", () => {
          if (!isAppStarted) return;

          const name = target.getAttribute('data-name');
          const mediaId = target.getAttribute('data-id');
          const srcUrl = target.getAttribute('data-src');
          const media = document.querySelector(mediaId);

          addLog(`Bulundu: ${name}`);

          // 1. DÄ°ÄžER HER ÅžEYÄ° DURDUR (En Ã¶nemli kÄ±sÄ±m)
          stopOtherMedias(mediaId);

          // 2. MedyayÄ± YÃ¼kle/Oynat
          if (!media.getAttribute('src')) {
            media.setAttribute('src', srcUrl);
            media.load();
            showLoader(name, true);
            trackProgress(media);
          } else {
            if (media.readyState >= 3) {
              media.play();
            } else {
              showLoader(name, true);
              trackProgress(media);
            }
          }
        });

        target.addEventListener("targetLost", () => {
          const mediaId = target.getAttribute('data-id');
          const media = document.querySelector(mediaId);
          if (media) {
            media.pause();
            // Not: currentTime'Ä± sÄ±fÄ±rlamÄ±yoruz, belki geri dÃ¶ner diye.
          }
          showLoader("", false); // YÃ¼kleme barÄ±nÄ± gizle
        });
      });

      function showLoader(name, show) {
        loaderOverlay.style.display = show ? 'block' : 'none';
        if(show) loadName.innerText = name;
      }

      function trackProgress(media) {
        // Eski interval varsa temizle (Ã‡akÄ±ÅŸmayÄ± Ã¶nler)
        if(media.progressInterval) clearInterval(media.progressInterval);

        media.progressInterval = setInterval(() => {
          if (media.readyState >= 3) {
            clearInterval(media.progressInterval);
            showLoader("", false);
            media.play();
            return;
          }

          if (media.buffered.length > 0 && media.duration) {
            const end = media.buffered.end(media.buffered.length - 1);
            const percent = Math.floor((end / media.duration) * 100);
            loadBar.style.width = percent + '%';
            loadPercent.innerText = percent;
          }
        }, 250);
      }
    </script>
  </body>
</html>
