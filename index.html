<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Efsaneler Sergisi AR v1.2.0</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
      body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; background: black; }

      /* --- SAĞ ÜST PANEL --- */
      #top-right-panel {
        position: fixed; top: 10px; right: 10px; z-index: 1000;
        display: flex; flex-direction: column; align-items: flex-end; gap: 5px;
      }
      .version-tag {
        background: rgba(0, 50, 0, 0.8); color: #00ff00; padding: 5px 10px;
        border: 1px solid #00ff00; border-radius: 5px; font-weight: bold; font-size: 14px;
      }
      #log-btn {
        background: rgba(255, 255, 255, 0.2); color: white; border: none; 
        border-radius: 5px; cursor: pointer; padding: 5px 10px; font-size: 12px;
      }

      /* --- LOG PENCERESİ --- */
      #log-modal {
        position: fixed; top: 80px; right: 10px; width: 320px; max-height: 250px;
        background: rgba(0, 0, 0, 0.95); z-index: 999;
        overflow-y: auto; border: 1px solid #444; display: none;
        color: #0f0; font-family: monospace; font-size: 11px; padding: 10px; border-radius: 5px;
        box-shadow: -5px 5px 15px rgba(0,0,0,0.5);
      }
      .log-entry { border-bottom: 1px solid #333; padding: 4px 0; }
      .log-time { color: #888; margin-right: 5px; }

      /* --- YÜKLEME EKRANI (PROGRESS) --- */
      #loader-overlay {
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 70%; z-index: 2000; display: none;
        text-align: center; background: rgba(20, 20, 20, 0.9); padding: 25px; 
        border-radius: 12px; border: 1px solid #555;
      }
      .progress-container {
        width: 100%; background-color: #333; border-radius: 10px; margin-top: 15px; height: 12px; overflow: hidden;
      }
      .progress-bar {
        width: 0%; height: 100%; background-color: #e67e22; transition: width 0.2s;
      }
      .loading-text { color: white; font-size: 16px; font-weight: bold; }
      .percentage { color: #e67e22; }

      /* --- BAŞLANGIÇ EKRANI --- */
      #start-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); z-index: 3000;
        display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;
      }
      #start-btn {
        padding: 15px 50px; font-size: 20px; background: #27ae60; color: white;
        border: none; border-radius: 50px; cursor: pointer; margin-top: 30px;
        box-shadow: 0 0 20px rgba(39, 174, 96, 0.5); font-weight: bold;
        transition: transform 0.1s;
      }
      #start-btn:active { transform: scale(0.95); }
    </style>
  </head>
  <body>

    <div id="start-screen">
      <h1 style="margin-bottom: 5px;">SANAL SERGİ</h1>
      <p style="color: #bbb; margin-top: 0;">Artırılmış Gerçeklik Deneyimi</p>
      <button id="start-btn">BAŞLAT</button>
      <p style="font-size: 12px; color: #666; margin-top: 50px;">v1.2.0 Stable</p>
    </div>

    <div id="top-right-panel">
      <div class="version-tag">v1.2.0</div>
      <button id="log-btn">LOGLARI GÖSTER</button>
    </div>

    <div id="log-modal">
      <div id="log-content"></div>
    </div>

    <div id="loader-overlay">
      <div class="loading-text"><span id="load-name">Medya</span> Yükleniyor... <span class="percentage" id="load-percent">0%</span></div>
      <div class="progress-container">
        <div class="progress-bar" id="load-bar"></div>
      </div>
      <div style="font-size: 11px; color: #aaa; margin-top: 5px;">Lütfen bekleyiniz, internet hızına bağlıdır.</div>
    </div>

    <a-scene 
      mindar-image="imageTargetSrc: ./konser/targets.mind; maxTrack: 1; filterMinCF:0.0001; filterBeta: 0.001; warmupTolerance: 5; missTolerance: 5" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">

      <a-assets>
        <audio id="soundOrhan" preload="none"></audio>
        <video id="vidVeysel" preload="none" loop="true" playsinline webkit-playsinline crossorigin="anonymous"></video>
        <video id="vidBaris" preload="none" loop="true" playsinline webkit-playsinline crossorigin="anonymous"></video>
        <video id="vidZeki" preload="none" loop="true" playsinline webkit-playsinline crossorigin="anonymous"></video>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0" class="art-target" 
                data-id="#soundOrhan" data-src="./konser/Hatasiz_Kul_Olmaz-Orhan _Gencebay.mp3" data-name="Orhan Gencebay">
        <a-entity position="0 0 0" animation="property: rotation; to: 0 0 360; dur: 5000; easing: linear; loop: true">
            <a-ring color="black" radius-inner="0.1" radius-outer="0.5"></a-ring>
            <a-circle color="#c0392b" radius="0.15"></a-circle>
        </a-entity>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 1" class="art-target" 
                data-id="#vidVeysel" data-src="./konser/asik_veysel_trt_kara_toprak.mp4" data-name="Aşık Veysel">
        <a-video src="#vidVeysel" position="0 0 0" height="1" width="1"></a-video>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 2" class="art-target" 
                data-id="#vidBaris" data-src="./konser/baris_manco_Gulpembe.mp4" data-name="Barış Manço">
        <a-video src="#vidBaris" position="0 0 0" height="1" width="1.3"></a-video>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 3" class="art-target" 
                data-id="#vidZeki" data-src="./konser/zeki_muren_Ah_bu_sarkilarin_gozu_kor_olsun.mp4" data-name="Zeki Müren">
        <a-video src="#vidZeki" position="0 0 0" height="1" width="1"></a-video>
      </a-entity>

    </a-scene>

    <script>
      // --- VERSİYON GEÇMİŞİ (Loglarda Görülecek) ---
      const APP_VERSION = "v1.2.0";
      const VERSION_HISTORY = [
        "v1.0.0: Safiye Ayla - İlk prototip (Tekli hedef)",
        "v1.1.0: Efsaneler Sergisi - Çoklu hedef sistemi eklendi (Gallery)",
        "v1.2.0: Stable - UI/UX Hataları giderildi. Başlat butonu kilidi eklendi. Ses çakışması çözüldü."
      ];

      // --- GLOBAL DEĞİŞKENLER ---
      let isAppStarted = false; // Başlat butonuna basıldı mı?
      let currentPlayingMedia = null; // Şu an ne çalıyor?

      // UI Elementleri
      const startScreen = document.getElementById('start-screen');
      const startBtn = document.getElementById('start-btn');
      const logContent = document.getElementById('log-content');
      const logModal = document.getElementById('log-modal');
      const logBtn = document.getElementById('log-btn');
      
      const loaderOverlay = document.getElementById('loader-overlay');
      const loadBar = document.getElementById('load-bar');
      const loadPercent = document.getElementById('load-percent');
      const loadName = document.getElementById('load-name');

      // --- LOG SİSTEMİ ---
      function addLog(msg) {
        const now = new Date();
        const time = now.toLocaleTimeString();
        const div = document.createElement('div');
        div.className = 'log-entry';
        div.innerHTML = `<span class="log-time">[${time}]</span> ${msg}`;
        logContent.prepend(div);
        console.log(`[AR-LOG] ${msg}`);
      }

      // Versiyon geçmişini loga bas
      VERSION_HISTORY.forEach(h => addLog(h));

      // Log penceresini aç/kapa
      logBtn.addEventListener('click', () => {
        logModal.style.display = (logModal.style.display === 'block') ? 'none' : 'block';
      });

      // --- BAŞLAT BUTONU (MASTER SWITCH) ---
      startBtn.addEventListener('click', () => {
        isAppStarted = true;
        startScreen.style.display = 'none';
        addLog("KULLANICI BAŞLAT BUTONUNA BASTI - AR AKTİF");
        
        // Ses motorunu ısıt (iOS fix)
        // Boş bir ses çalıp durduruyoruz ki tarayıcı ses izni versin
        const dummyAudio = new Audio();
        dummyAudio.play().then(() => dummyAudio.pause()).catch(() => {});
      });

      // --- MEDYA KONTROL MERKEZİ ---
      
      // Tüm medyaları zorla durduran fonksiyon
      function stopAllMedia() {
        const allMedia = document.querySelectorAll('video, audio');
        allMedia.forEach(m => {
          m.pause();
          m.currentTime = 0; // Başa sar
        });
        currentPlayingMedia = null;
        addLog("Tüm medyalar susturuldu.");
      }

      // --- HEDEF BULMA MANTIĞI ---
      const targets = document.querySelectorAll('.art-target');

      targets.forEach(target => {
        // Hedef Bulundu
        target.addEventListener("targetFound", () => {
          const name = target.getAttribute('data-name');
          
          // EĞER BUTONA BASILMADIYSA HİÇBİR ŞEY YAPMA!
          if (!isAppStarted) {
            console.log("Hedef bulundu ama başlat butonuna basılmadı: " + name);
            return; 
          }

          addLog(`GÖRÜNTÜ ALGILANDI: ${name}`);

          // 1. Önce her şeyi sustur (Çakışmayı önle)
          stopAllMedia();

          const mediaId = target.getAttribute('data-id');
          const srcUrl = target.getAttribute('data-src');
          const media = document.querySelector(mediaId);

          // 2. Medyayı Hazırla ve Oynat
          if (media) {
            currentPlayingMedia = media;
            playMediaSafe(media, srcUrl, name);
          }
        });

        // Hedef Kayboldu
        target.addEventListener("targetLost", () => {
          const name = target.getAttribute('data-name');
          addLog(`GÖRÜNTÜ KAYBOLDU: ${name}`);
          
          // Yükleme ekranını gizle
          loaderOverlay.style.display = 'none';

          // Çalanı durdur
          const mediaId = target.getAttribute('data-id');
          const media = document.querySelector(mediaId);
          if (media) {
            media.pause();
          }
        });
      });

      // --- GÜVENLİ OYNATMA VE YÜKLEME TAKİBİ ---
      function playMediaSafe(media, src, name) {
        
        // Eğer kaynak atanmamışsa ata
        if (!media.getAttribute('src')) {
          addLog(`${name} internetten indiriliyor...`);
          media.setAttribute('src', src);
          media.load();
        }

        // Eğer video hazır değilse (readyState < 3)
        if (media.readyState < 3) {
          loaderOverlay.style.display = 'block';
          loadName.innerText = name;
          trackDownloadProgress(media);
        } else {
          // Hazırsa direkt oynat
          addLog(`${name} önbellekten oynatılıyor.`);
          media.play().catch(e => addLog("Oynatma hatası: " + e));
        }

        // Oynayabilir hale gelince
        media.oncanplay = () => {
          loaderOverlay.style.display = 'none';
          // Sadece şu anki hedef hala buysa oynat (Kullanıcı kamerayı çevirmiş olabilir)
          if (currentPlayingMedia === media) {
             media.play();
             addLog(`${name} OYNATILIYOR ▶️`);
          }
        };
      }

      // --- YÜZDELİK HESAPLAMA ---
      function trackDownloadProgress(media) {
        loadBar.style.width = '0%';
        loadPercent.innerText = '0%';

        const interval = setInterval(() => {
          // Eğer medya oynuyorsa veya başka bir hedefe geçildiyse takibi bırak
          if (media.readyState >= 3 || currentPlayingMedia !== media) {
            clearInterval(interval);
            loadBar.style.width = '100%';
            loadPercent.innerText = '100%';
            setTimeout(() => { loaderOverlay.style.display = 'none'; }, 500);
            return;
          }

          // Buffer bilgisini oku
          if (media.buffered.length > 0) {
            // Süresi belli değilse tahmini ilerle
            const duration = media.duration;
            if (duration > 0) {
                const bufferedEnd = media.buffered.end(media.buffered.length - 1);
                const percent = Math.floor((bufferedEnd / duration) * 100);
                loadBar.style.width = percent + '%';
                loadPercent.innerText = percent + '%';
            } else {
                // Süre alınamıyorsa yapay ilerleme (kullanıcı dondu sanmasın)
                loadBar.style.width = '50%';
                loadPercent.innerText = 'Yükleniyor...';
            }
          }
        }, 200);
      }

    </script>
  </body>
</html>
