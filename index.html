<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sanal Sergi v1.4.0</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    
    <style>
      body { margin: 0; font-family: 'Segoe UI', sans-serif; overflow: hidden; background: black; }

      /* --- GÄ°RÄ°Åž EKRANI --- */
      #start-screen {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.95); z-index: 3000;
        display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;
      }
      #start-btn {
        padding: 15px 60px; font-size: 22px; background: #27ae60; color: white;
        border: none; border-radius: 50px; cursor: pointer; margin-top: 20px;
        font-weight: bold; letter-spacing: 1px; box-shadow: 0 0 15px rgba(39, 174, 96, 0.6);
      }
      .version-display { margin-top: 15px; color: #888; font-size: 14px; font-family: monospace; }

      /* --- SAÄž ÃœST PANEL --- */
      #top-right-panel {
        position: fixed; top: 15px; right: 15px; z-index: 1000;
        display: flex; align-items: center; gap: 8px;
      }
      .version-tag {
        background: rgba(0, 0, 0, 0.6); color: #00ff00; padding: 4px 8px;
        border: 1px solid #00ff00; border-radius: 4px; font-weight: bold; font-size: 12px;
      }
      #log-btn {
        background: rgba(0, 0, 0, 0.6); color: white; border: 1px solid #777; 
        border-radius: 50%; width: 36px; height: 36px; cursor: pointer; 
        display: flex; align-items: center; justify-content: center; font-size: 18px;
      }

      /* --- LOG PENCERESÄ° --- */
      #log-modal {
        position: fixed; top: 60px; right: 15px; width: 300px; max-height: 250px;
        background: rgba(0, 0, 0, 0.95); z-index: 999;
        overflow-y: auto; border: 1px solid #444; display: none;
        color: #0f0; font-family: monospace; font-size: 11px; padding: 10px; border-radius: 5px;
      }
      .log-entry { border-bottom: 1px solid #333; padding: 4px 0; }
      .log-time { color: #888; margin-right: 5px; }

      /* --- YÃœKLEME BAR --- */
      #loader-overlay {
        position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
        width: 70%; z-index: 2000; display: none;
        text-align: center; background: rgba(0, 0, 0, 0.85); padding: 15px; 
        border-radius: 12px; border: 1px solid #555;
      }
      .progress-container {
        width: 100%; background-color: #333; border-radius: 10px; margin-top: 8px; height: 10px; overflow: hidden;
      }
      .progress-bar {
        width: 0%; height: 100%; background-color: #e67e22; transition: width 0.3s;
      }
      .loading-text { color: white; font-size: 14px; font-weight: bold; }
    </style>
  </head>
  <body>

    <div id="start-screen">
      <h1>SANAL SERGÄ°</h1>
      <p style="color: #bbb;">MÃ¼zeye HoÅŸ Geldiniz</p>
      <button id="start-btn">BAÅžLAT</button>
      <div class="version-display" id="intro-version">v1.4.0</div>
    </div>

    <div id="top-right-panel">
      <div class="version-tag" id="ui-version">v1.4.0</div>
      <button id="log-btn" title="LoglarÄ± GÃ¶ster">ðŸ“‹</button>
    </div>

    <div id="log-modal">
      <div id="log-content"></div>
    </div>

    <div id="loader-overlay">
      <div class="loading-text"><span id="load-name">Veri</span> Ä°ndiriliyor... <span id="load-percent" style="color:#e67e22">0%</span></div>
      <div class="progress-container">
        <div class="progress-bar" id="load-bar"></div>
      </div>
      <div style="font-size: 10px; color:#aaa; margin-top:5px;">Ä°nternet hÄ±zÄ±na gÃ¶re bekleyiniz.</div>
    </div>

    <a-scene 
      mindar-image="imageTargetSrc: ./konser/targets.mind; maxTrack: 1; filterMinCF:0.0001; filterBeta: 0.001; warmupTolerance: 5; missTolerance: 10" 
      color-space="sRGB" 
      renderer="colorManagement: true, physicallyCorrectLights" 
      vr-mode-ui="enabled: false" 
      device-orientation-permission-ui="enabled: false">

      <a-assets>
        <audio id="soundOrhan" preload="none"></audio>
        <video id="vidVeysel" preload="none" loop="true" playsinline webkit-playsinline crossorigin="anonymous"></video>
        <video id="vidBaris" preload="none" loop="true" playsinline webkit-playsinline crossorigin="anonymous"></video>
        <video id="vidZeki" preload="none" loop="true" playsinline webkit-playsinline crossorigin="anonymous"></video>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0" class="art-target" 
                data-id="#soundOrhan" data-src="./konser/Hatasiz_Kul_Olmaz-Orhan _Gencebay.mp3" data-name="Orhan Gencebay">
        <a-entity position="0 0 0" animation="property: rotation; to: 0 0 360; dur: 5000; easing: linear; loop: true">
            <a-ring color="black" radius-inner="0.1" radius-outer="0.5"></a-ring>
            <a-circle color="#c0392b" radius="0.15"></a-circle>
        </a-entity>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 1" class="art-target" 
                data-id="#vidVeysel" data-src="./konser/asik_veysel_trt_kara_toprak.mp4" data-name="AÅŸÄ±k Veysel">
        <a-video src="#vidVeysel" position="0 0 0" height="1" width="1"></a-video>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 2" class="art-target" 
                data-id="#vidBaris" data-src="./konser/baris_manco_Gulpembe.mp4" data-name="BarÄ±ÅŸ ManÃ§o">
        <a-video src="#vidBaris" position="0 0 0" height="1" width="1.3"></a-video>
      </a-entity>

      <a-entity mindar-image-target="targetIndex: 3" class="art-target" 
                data-id="#vidZeki" data-src="./konser/zeki_muren_Ah_bu_sarkilarin_gozu_kor_olsun.mp4" data-name="Zeki MÃ¼ren">
        <a-video src="#vidZeki" position="0 0 0" height="1" width="1"></a-video>
      </a-entity>

    </a-scene>

    <script>
      // --- VERSÄ°YON YÃ–NETÄ°MÄ° ---
      const APP_VERSION = "v1.4.0";
      // Ekrana yazdÄ±r
      document.getElementById('intro-version').innerText = APP_VERSION;
      document.getElementById('ui-version').innerText = APP_VERSION;

      // GeÃ§miÅŸ
      const VERSION_HISTORY = [
        "v1.4.0: Kritik 'Kilitlenme' hatasÄ± giderildi. YÃ¼zdelik bar dÃ¼zeltildi.",
        "v1.3.0: ArayÃ¼z ikonlaÅŸtÄ±. Performans artÄ±rÄ±ldÄ±.",
        "v1.2.0: BaÅŸlat butonu kilidi ve Lazy Load eklendi.",
        "v1.1.0: Ã‡oklu Sergi Modu (Multi-target) eklendi.",
        "v1.0.0: Safiye Ayla Prototipi (Ä°lk sÃ¼rÃ¼m)."
      ];

      // --- DEÄžÄ°ÅžKENLER ---
      let isAppStarted = false;
      const logContent = document.getElementById('log-content');
      const logModal = document.getElementById('log-modal');
      const logBtn = document.getElementById('log-btn');
      
      const loaderOverlay = document.getElementById('loader-overlay');
      const loadBar = document.getElementById('load-bar');
      const loadPercent = document.getElementById('load-percent');
      const loadName = document.getElementById('load-name');

      // Log Fonksiyonu
      function addLog(msg) {
        const now = new Date();
        const time = now.toLocaleTimeString().split(' ')[0];
        const div = document.createElement('div');
        div.className = 'log-entry';
        div.innerHTML = `<span class="log-time">${time}</span> ${msg}`;
        logContent.prepend(div);
      }

      // GeÃ§miÅŸi Loga Ekle
      VERSION_HISTORY.forEach(h => addLog(h));

      // Log Butonu
      logBtn.addEventListener('click', () => {
        logModal.style.display = (logModal.style.display === 'block') ? 'none' : 'block';
      });

      // --- BAÅžLATMA ---
      document.getElementById('start-btn').addEventListener('click', () => {
        isAppStarted = true;
        document.getElementById('start-screen').style.display = 'none';
        addLog("Sistem BaÅŸlatÄ±ldÄ± - Kamera Aktif");
        
        // Ses Ä°zni
        const dummy = new Audio();
        dummy.play().then(()=>dummy.pause()).catch(()=>{});
      });

      // --- HEDEF YÃ–NETÄ°MÄ° (KÄ°LÄ°TLENME Ã‡Ã–ZÃœMÃœ) ---
      
      const targets = document.querySelectorAll('.art-target');
      let loadingInterval = null; // Global interval deÄŸiÅŸkeni

      targets.forEach(target => {
        
        target.addEventListener("targetFound", () => {
          if (!isAppStarted) return;
          
          const name = target.getAttribute('data-name');
          const mediaId = target.getAttribute('data-id');
          const srcUrl = target.getAttribute('data-src');
          const media = document.querySelector(mediaId);

          addLog(`GÃ–RÃœNTÃœ BULUNDU: ${name}`);

          // ADIM 1: DÄ°ÄžER HER ÅžEYÄ° DURDUR (ZORUNLU)
          resetAllMedia(mediaId);

          // ADIM 2: MEDYA Ä°ÅžLEMLERÄ°
          if (!media.getAttribute('src')) {
            // Ä°lk defa yÃ¼kleniyor
            media.setAttribute('src', srcUrl);
            media.load();
            showLoader(name, true);
            monitorProgress(media);
          } else {
            // Zaten yÃ¼klÃ¼ mÃ¼?
            if (media.readyState >= 3) {
              media.play();
              addLog(`${name} oynatÄ±lÄ±yor.`);
            } else {
              // YÃ¼klÃ¼ ama hazÄ±r deÄŸil (Buffering)
              media.load(); // Tekrar tetikle
              showLoader(name, true);
              monitorProgress(media);
            }
          }
        });

        target.addEventListener("targetLost", () => {
          const mediaId = target.getAttribute('data-id');
          const media = document.querySelector(mediaId);
          
          if (media) {
            media.pause();
          }
          
          // Loader'Ä± kapat ve sayacÄ± temizle
          showLoader("", false);
          if (loadingInterval) clearInterval(loadingInterval);
        });
      });

      // DiÄŸer tÃ¼m videolarÄ± resetleyen fonksiyon
      function resetAllMedia(exceptId) {
        const allMedia = document.querySelectorAll('video, audio');
        allMedia.forEach(m => {
          // EÄŸer bu medya, ÅŸu an bulunan hedef deÄŸilse
          if (m.id !== exceptId.replace('#', '')) {
            m.pause();
            m.currentTime = 0; // BaÅŸa sar
            m.removeAttribute('src'); // RAM'den dÃ¼ÅŸÃ¼rmeyi dene (Zorunlu deÄŸil ama stabilite artÄ±rÄ±r)
            m.load(); // BoÅŸ kaynaÄŸÄ± yÃ¼kle
          }
        });
      }

      // --- LOADER VE YÃœZDE HESAPLAMA (DÃœZELTÄ°LDÄ°) ---
      
      function showLoader(name, isVisible) {
        if (isVisible) {
          loaderOverlay.style.display = 'block';
          loadName.innerText = name;
          loadBar.style.width = '0%';
          loadPercent.innerText = '0%';
        } else {
          loaderOverlay.style.display = 'none';
        }
      }

      function monitorProgress(media) {
        if (loadingInterval) clearInterval(loadingInterval);

        loadingInterval = setInterval(() => {
          // EÄŸer video hazÄ±rsa bitir
          if (media.readyState >= 3) {
            clearInterval(loadingInterval);
            loadBar.style.width = '100%';
            loadPercent.innerText = '100%';
            setTimeout(() => { showLoader("", false); media.play(); }, 500);
            return;
          }

          // Metadata okunmadan sÃ¼re (duration) Infinity dÃ¶ner, bu yÃ¼zden bekliyoruz
          if (media.duration && isFinite(media.duration) && media.buffered.length > 0) {
             const end = media.buffered.end(media.buffered.length - 1);
             const percent = Math.floor((end / media.duration) * 100);
             
             loadBar.style.width = percent + '%';
             loadPercent.innerText = percent + '%';
          } else {
             // HenÃ¼z bilgi yoksa yapay bir hareket ver (KullanÄ±cÄ± dondu sanmasÄ±n)
             loadPercent.innerText = "BaÄŸlanÄ±yor...";
          }
        }, 200);
      }

    </script>
  </body>
</html>
